<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>Детальный отчёт CPET</title>
    <style>
        @page {
            size: A4;
            margin: 12mm;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DejaVu Sans', Arial, sans-serif;
            font-size: 10pt;
            line-height: 1.3;
            color: #333;
        }

        h1 {
            font-size: 14pt;
            margin-bottom: 10px;
        }

        h2 {
            font-size: 12pt;
            margin: 15px 0 8px;
            color: #c00;
            text-decoration: underline;
        }

        .header {
            border: 2px solid #000;
            padding: 10px;
            margin-bottom: 15px;
        }

        .header p {
            margin: 5px 0;
        }

        .header .name {
            font-size: 12pt;
            font-weight: bold;
            color: #c00;
        }

        table {
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        th,
        td {
            border: 1px solid #000;
            padding: 4px 8px;
            text-align: center;
        }

        th {
            background: #f0f0f0;
            font-weight: bold;
        }

        .data-table {
            width: 100%;
        }

        .data-table th {
            font-size: 9pt;
        }

        .data-table td {
            font-size: 9pt;
        }

        .chart-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            page-break-inside: avoid;
        }

        .chart-table {
            flex: 0 0 200px;
        }

        .chart-graph {
            flex: 1;
            min-height: 200px;
            border: 1px solid #ccc;
            padding: 10px;
            position: relative;
        }

        .chart-title {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .level-table {
            width: 100%;
            margin: 15px 0;
        }

        .level-table th {
            background: #f5f5f5;
        }

        .level-table .marker {
            color: #0a0;
            font-size: 14pt;
            font-weight: bold;
        }

        .level-table .your-value {
            font-weight: bold;
        }

        .examples {
            margin: 15px 0;
        }

        .examples ul {
            margin-left: 20px;
        }

        .examples li {
            margin: 5px 0;
        }

        .conclusion {
            border: 2px solid #000;
            padding: 10px;
            margin-top: 20px;
        }

        .conclusion h2 {
            margin-top: 0;
        }

        .bar-graph {
            display: flex;
            align-items: flex-end;
            height: 150px;
            gap: 3px;
            padding: 10px 0;
        }

        .bar-group {
            display: flex;
            align-items: flex-end;
            gap: 2px;
        }

        .bar {
            width: 18px;
            transition: height 0.3s;
        }

        .bar-blue {
            background: #4a7ab7;
        }

        .bar-red {
            background: #c44;
        }

        .bar-label {
            font-size: 8pt;
            text-align: center;
            margin-top: 3px;
        }

        .line-chart {
            width: 100%;
            height: 180px;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <div class="header">
        <p class="name">ФИО: {{ client.name }}</p>
        <p>Вид спорта: {{ test.sport }}</p>
        <p>Тест: {{ test.date }} на {{ test.equipment }}, каденс ~{{ test.cadence }}, вес {{ client.weight }} кг</p>
        <p>{{ test.notes }}</p>
    </div>

    <!-- Main Data Table -->
    <table class="data-table">
        <tr>
            <th>Время</th>
            <th>Ватты</th>
            <th>ЧСС<br>уд/мин</th>
            <th>La<br>ммоль/л</th>
            <th>O2</th>
            <th>ЛВ</th>
            <th>Глуб.дых</th>
            <th>Частота<br>дых</th>
        </tr>
        {% for row in data_rows %}
        <tr>
            <td>{{ row.time }}</td>
            <td>{{ row.power }}</td>
            <td>{{ row.hr }}</td>
            <td>{{ row.lactate }}</td>
            <td>{{ row.vo2 }}</td>
            <td>{{ row.ve }}</td>
            <td>{{ row.tv }}</td>
            <td>{{ row.rf }}</td>
        </tr>
        {% endfor %}
    </table>

    <!-- HR and Power Chart -->
    <h2>ЧСС и мощность</h2>
    <div class="chart-section">
        <table class="chart-table">
            <tr>
                <th>Мощность</th>
                <th>{{ test.date_1 }}</th>
                <th>{{ test.date_2 }}</th>
            </tr>
            {% for row in hr_comparison %}
            <tr>
                <td>{{ row.power }}</td>
                <td>{{ row.hr_1 }}</td>
                <td>{{ row.hr_2 }}</td>
            </tr>
            {% endfor %}
        </table>
        <div class="chart-graph">
            <div class="chart-title">ЧСС {{ test.date_1 }} и {{ test.date_2 }}</div>
            <svg class="line-chart" viewBox="0 0 300 150">
                <!-- Grid -->
                <line x1="30" y1="10" x2="30" y2="130" stroke="#ccc" />
                <line x1="30" y1="130" x2="290" y2="130" stroke="#ccc" />
                <!-- Legend -->
                <line x1="180" y1="15" x2="200" y2="15" stroke="#4a7ab7" stroke-width="2" />
                <text x="205" y="18" font-size="8">{{ test.date_1 }}</text>
                <line x1="240" y1="15" x2="260" y2="15" stroke="#c44" stroke-width="2" />
                <text x="265" y="18" font-size="8">{{ test.date_2 }}</text>
                <!-- Y axis labels -->
                <text x="5" y="20" font-size="7">200</text>
                <text x="5" y="70" font-size="7">150</text>
                <text x="5" y="130" font-size="7">100</text>
            </svg>
        </div>
    </div>

    <!-- Ventilation Chart -->
    <h2>Лёгочная вентиляция</h2>
    <div class="chart-section">
        <table class="chart-table">
            <tr>
                <th>Мощность</th>
                <th>{{ test.date_1 }}</th>
                <th>{{ test.date_2 }}</th>
            </tr>
            {% for row in ve_comparison %}
            <tr>
                <td>{{ row.power }}</td>
                <td>{{ row.ve_1 }}</td>
                <td>{{ row.ve_2 }}</td>
            </tr>
            {% endfor %}
        </table>
        <div class="chart-graph">
            <div class="chart-title">{{ test.date_1 }} и {{ test.date_2 }}</div>
            <svg class="line-chart" viewBox="0 0 300 150">
                <line x1="30" y1="10" x2="30" y2="130" stroke="#ccc" />
                <line x1="30" y1="130" x2="290" y2="130" stroke="#ccc" />
            </svg>
        </div>
    </div>

    <!-- O2 Consumption Chart -->
    <h2>Потребление кислорода</h2>
    <div class="chart-section">
        <table class="chart-table">
            <tr>
                <th>Мощность</th>
                <th>{{ test.date_1 }}</th>
                <th>{{ test.date_2 }}</th>
            </tr>
            {% for row in vo2_comparison %}
            <tr>
                <td>{{ row.power }}</td>
                <td>{{ row.vo2_1 }}</td>
                <td>{{ row.vo2_2 }}</td>
            </tr>
            {% endfor %}
        </table>
        <div class="chart-graph">
            <div class="chart-title">{{ test.date_1 }} и {{ test.date_2 }}</div>
            <svg class="line-chart" viewBox="0 0 300 150"></svg>
        </div>
    </div>

    <!-- Lactate Chart -->
    <h2>Лактат</h2>
    <div class="chart-section">
        <table class="chart-table">
            <tr>
                <th>Мощность</th>
                <th>{{ test.date_1 }}</th>
                <th>{{ test.date_2 }}</th>
            </tr>
            {% for row in lactate_comparison %}
            <tr>
                <td>{{ row.power }}</td>
                <td>{{ row.la_1 }}</td>
                <td>{{ row.la_2 }}</td>
            </tr>
            {% endfor %}
        </table>
        <div class="chart-graph">
            <div class="chart-title">{{ test.date_1 }} и {{ test.date_2 }}</div>
            <div class="bar-graph">
                {% for row in lactate_comparison %}
                <div class="bar-group">
                    <div class="bar bar-blue" style="height: {{ row.la_1|default(0) * 10 }}px;"></div>
                    <div class="bar bar-red" style="height: {{ row.la_2|default(0) * 10 }}px;"></div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Skill Level Matrix -->
    <h2>Ваш уровень развития отмечен:</h2>
    <table class="level-table">
        <tr>
            <th>Ваши:</th>
            <th>1 балл</th>
            <th>2 балла</th>
            <th>3 балла</th>
            <th>4 балла<br>КМС</th>
            <th>5 баллов<br>МС</th>
            <th>6 баллов<br>МСМК</th>
            <th>Лучшие<br>в мире</th>
        </tr>
        {% for skill in skills %}
        <tr>
            <td class="your-value">{{ skill.name }}<br>{{ skill.your_value }} ватт</td>
            <td>{{ skill.level_1 }}{% if skill.your_level == 1 %}<br><span class="marker">◆</span>{% endif %}</td>
            <td>{{ skill.level_2 }}{% if skill.your_level == 2 %}<br><span class="marker">◆</span>{% endif %}</td>
            <td>{{ skill.level_3 }}{% if skill.your_level == 3 %}<br><span class="marker">◆</span>{% endif %}</td>
            <td>{{ skill.level_4 }}{% if skill.your_level == 4 %}<br><span class="marker">◆</span>{% endif %}</td>
            <td>{{ skill.level_5 }}{% if skill.your_level == 5 %}<br><span class="marker">◆</span>{% endif %}</td>
            <td>{{ skill.level_6 }}{% if skill.your_level == 6 %}<br><span class="marker">◆</span>{% endif %}</td>
            <td>{{ skill.world_best }}</td>
        </tr>
        {% endfor %}
    </table>
    <p style="font-size: 9pt; color: #c00;">*цифра в ячейке - левая грань ячейки</p>

    <!-- Reference Examples -->
    <div class="examples">
        <p><strong>Примеры для мужчин:</strong></p>
        <ul>
            {% for example in examples %}
            <li>{{ example }}</li>
            {% endfor %}
        </ul>
    </div>

    <!-- Conclusion -->
    <div class="conclusion">
        <h2>Заключение:</h2>
        <p>{{ conclusion }}</p>
    </div>
</body>

</html>